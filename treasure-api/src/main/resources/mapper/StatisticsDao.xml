<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.treasure.dao.StatisticsDao">


    <resultMap type="io.treasure.entity.MasterOrderEntity" id="masterOrderMap">

        <result property="id" column="id"/>
        <result property="orderId" column="order_id"/>
        <result property="merchantId" column="merchant_id"/>
        <result property="roomId" column="room_id"/>
        <result property="reservationType" column="reservation_type"/>
        <result property="reservationId" column="reservation_id"/>
        <result property="discountId" column="discount_id"/>
        <result property="eatTime" column="eat_time"/>
        <result property="totalMoney" column="total_money"/>
        <result property="payMoney" column="pay_money"/>
        <result property="status" column="status"/>
        <result property="payMode" column="pay_mode"/>
        <result property="invoice" column="invoice"/>
        <result property="description" column="description"/>
        <result property="payDate" column="pay_date"/>
        <result property="contacts" column="contacts"/>
        <result property="contactNumber" column="contact_number"/>
        <result property="checkStatus" column="check_status"/>
        <result property="checkMode" column="check_mode"/>
        <result property="refundReason" column="refund_reason"/>
        <result property="refundId" column="refund_id"/>
        <result property="refundDate" column="refund_date"/>
        <result property="updateDate" column="update_date"/>
        <result property="createDate" column="create_date"/>
        <result property="creator" column="creator"/>
        <result property="updater" column="updater"/>
    </resultMap>
    <select id="todayOrder" parameterType="io.treasure.entity.MasterOrderEntity" resultType="int">

        select count(*)  from ct_master_order    where  DATE_FORMAT(create_date,'%Y-%m-%d') = #{format}   <if test="merchantId != null">
        and merchant_id in
        <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
            #{item}
        </foreach>
    </if>
        and `status` != 9
        and p_order_id = '0'
    </select>
    <select id="todayReserve" parameterType="io.treasure.entity.MasterOrderEntity" resultType="int">
        select
        count(*)
        from
        ct_master_order
        where
        eat_time > now()
        <if test="merchantId != null">
            and merchant_id in
            <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        and status in (1,2,3,4,5,6,7)
        and  DATE_FORMAT(create_date,'%Y-%m-%d') = #{format}
        and p_order_id = '0'
    </select>
    <select id="todayQuit" parameterType="io.treasure.entity.MasterOrderEntity" resultType="int">

        select count(*)  from ct_master_order    where status in (6,7,8) and p_order_id='0' and  DATE_FORMAT(create_date,'%Y-%m-%d') = #{format}   <if test="merchantId != null">
        and merchant_id in
        <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
            #{item}
        </foreach>
    </if>
    </select>

    <select id="todayMoney" parameterType="io.treasure.entity.MasterOrderEntity" resultType="double">

        select IFNULL(sum(pay_money),0.00) from ct_master_order    where  DATE_FORMAT(create_date,'%Y-%m-%d') = #{format} and status in(2,4,7,10) and check_status = 1  <if test="merchantId != null">
        and merchant_id in
        <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
            #{item}
        </foreach>
    </if>
    </select>
    <select id="monthOrder" parameterType="io.treasure.entity.MasterOrderEntity" resultType="int">

        select count(*)  from ct_master_order    where  DATE_FORMAT(create_date,'%Y-%m') = #{month}   <if test="merchantId != null">
        and merchant_id in
        <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
            #{item}
        </foreach>
    </if>  and status != 9 and p_order_id='0'
    </select>

    <select id="monthReserve" parameterType="io.treasure.entity.MasterOrderEntity" resultType="int">

        select count(*)  from ct_master_order    where  eat_time > now()    <if test="merchantId != null">
        and merchant_id in
        <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
            #{item}
        </foreach>
    </if>  and status  in (1,2,3,4,5,6,7,10) and  DATE_FORMAT(create_date,'%Y-%m') = #{month} and p_order_id='0'
    </select>
    <select id="monthQuit" parameterType="io.treasure.entity.MasterOrderEntity" resultType="int">

        select count(*)  from ct_master_order    where  status in (6,7,8) and p_order_id='0' and  DATE_FORMAT(create_date,'%Y-%m') = #{month}  <if test="merchantId != null">
        and merchant_id in
        <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
            #{item}
        </foreach>
    </if>
    </select>
    <select id="monthMoney" parameterType="io.treasure.entity.MasterOrderEntity" resultType="double">

        select IFNULL(sum(pay_money),0.00)  from ct_master_order    where  DATE_FORMAT(create_date,'%Y-%m') = #{month} and status  in(2,4,7,10) and check_status = 1   <if test="merchantId != null">
        and merchant_id in
        <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
            #{item}
        </foreach>
    </if>
    </select>
    <select id="allMoney" parameterType="io.treasure.entity.MasterOrderEntity" resultType="double">

        select IFNULL(sum(pay_money),0.00)  from ct_master_order    where  status in(2,4,7,10)   <if test="merchantId != null">
        and merchant_id in
        <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
            #{item}
        </foreach>
    </if>
    </select>
    <select id="assignOrder" parameterType="io.treasure.entity.MasterOrderEntity"  resultType="java.lang.Integer">
        select count(*) from ct_master_order where
        `status` != 9
        and p_order_id = '0'
        <if test="merchantId != null">
            and merchant_id in
            <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>  and DATE_FORMAT(create_date,'%Y-%m-%d')
        between #{startTime1}
        and #{endTime1}
    </select>
    <select id="assignReserve" parameterType="io.treasure.entity.MasterOrderEntity" resultType="java.lang.Integer">
        select
        count(*)
        from
        ct_master_order
        where
        eat_time > now()
        <if test="merchantId != null">
            and merchant_id in
            <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        and status  in (1,2,3,4,5,6,7,10)
        and DATE_FORMAT(create_date,'%Y-%m-%d') between #{startTime1} and #{endTime1}
        and p_order_id = '0'
    </select>
    <select id="assignQuit"  parameterType="io.treasure.entity.MasterOrderEntity"  resultType="java.lang.Integer">
        select count(*) from ct_master_order where status in (6,7,8)   <if test="merchantId != null">
        and merchant_id in
        <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
            #{item}
        </foreach>
    </if>  and DATE_FORMAT(create_date,'%Y-%m-%d')
        between #{startTime1}
        and #{endTime1}
        and p_order_id= '0'
    </select>
    <select id="assignMoney" parameterType="io.treasure.entity.MasterOrderEntity" resultType="java.lang.Double">
        select IFNULL(sum(pay_money),0.00)  from ct_master_order    where  status in(2,4,7,10)   <if test="merchantId != null">
        and merchant_id in
        <foreach item="item" index="index" collection="merchantIdStr" open="(" separator="," close=")">
            #{item}
        </foreach>
    </if>  and DATE_FORMAT(create_date,'%Y-%m-%d') between #{startTime1}
        and #{endTime1}
        and check_status = 1
    </select>

    <!-- 查询商户热销产品排行统计 -->
    <select id="getTopSellersRanking" parameterType="io.treasure.dto.TopSellersRankingDto" resultType="io.treasure.vo.TopSellersRankingVo">
        select
        t.name,SUM(t.count) as count,SUM(t.total) as total ,t.icon as url
        from (
        SELECT
        cg.`name`,
        cg.icon,
        ctso.quantity-ctso.refund_quantity as count,
        ctso.price*(ctso.quantity-ctso.refund_quantity) as total
        from
        ct_slave_order ctso
        LEFT JOIN
        ct_good cg on
        ctso.good_id = cg.id
        WHERE
        ctso.order_id in (
        select
        ctmo.order_id
        from
        ct_master_order ctmo
        where
        ctmo.merchant_id = #{merchantId}
        and ctmo.`status` = 10
        <if test="startDate != null and startDate != ''" >
            and date_format(ctmo.create_date, '%Y-%m-%d') &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''" >
            and date_format(ctmo.create_date, '%Y-%m-%d') &lt;= #{endDate}
        </if>
        )
        and ctso.`status` = 10
        ) t
        GROUP BY
        name
        ORDER BY
        <if test="sortField == null or sortField==0" >
            total
        </if>
        <if test="sortField != null and sortField==1" >
            count
        </if>
        <if test="sort != null and sortField==0" >
            asc
        </if>
        <if test="sort == null or sortField==1" >
            desc
        </if>
    </select>

    <!-- 查询用户订单量排行DTO -->
    <select id="getConsumptionRanking" parameterType="io.treasure.dto.ConsumptionRankingDto" resultType="io.treasure.vo.ConsumptionRankingVo">
        select
        ccu.username as userName,
        COUNT(ccu.username) as count,
        (
        SELECT IFNULL(SUM(ctmo1.merchant_proceeds),0) FROM ct_master_order ctmo1 where ctmo1.creator = ccu.id and ctmo1.`status` = 10 and ctmo1.merchant_id = #{merchantId}
        <if test="startDate != null and startDate != ''" >
            and date_format(ctmo1.create_date, '%Y-%m-%d') &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''" >
            and date_format(ctmo1.create_date, '%Y-%m-%d') &lt;= #{endDate}
        </if>
        ) as completeTotal,
        (
        SELECT IFNULL(count(ctmo1.order_id),0) FROM ct_master_order ctmo1 where ctmo1.creator = ccu.id and ctmo1.`status` = 10 and ctmo1.merchant_id = #{merchantId}
        <if test="startDate != null and startDate != ''" >
            and date_format(ctmo1.create_date, '%Y-%m-%d') &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''" >
            and date_format(ctmo1.create_date, '%Y-%m-%d') &lt;= #{endDate}
        </if>
        and ctmo1.p_order_id = '0'
        ) as completeCount,
        (
        SELECT IFNULL(SUM(ctmo3.merchant_proceeds),0) FROM ct_master_order ctmo3 where ctmo3.creator = ccu.id and ctmo3.`status` in (3,5,8) and ctmo3.merchant_id = #{merchantId}
        <if test="startDate != null and startDate != ''" >
            and date_format(ctmo3.create_date, '%Y-%m-%d') &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''" >
            and date_format(ctmo3.create_date, '%Y-%m-%d') &lt;= #{endDate}
        </if>
        and ctmo3.p_order_id = '0'
        ) as cancelTotal,
        (
        SELECT IFNULL(count(ctmo3.order_id),0) FROM ct_master_order ctmo3 where ctmo3.creator = ccu.id and ctmo3.`status` in (3,5,8) and ctmo3.merchant_id = #{merchantId}
        <if test="startDate != null and startDate != ''" >
            and date_format(ctmo3.create_date, '%Y-%m-%d') &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''" >
            and date_format(ctmo3.create_date, '%Y-%m-%d') &lt;= #{endDate}
        </if>
        and ctmo3.p_order_id = '0'
        ) as cancelCount
        from
        ct_master_order ctmo
        LEFT JOIN
        ct_client_user ccu ON ctmo.creator = ccu.id
        WHERE
        ctmo.merchant_id = #{merchantId} and ctmo.`status` in (10 ,8 , 5, 3)
        <if test="startDate != null and startDate != ''" >
            and date_format(ctmo.create_date, '%Y-%m-%d') &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''" >
            and date_format(ctmo.create_date, '%Y-%m-%d') &lt;= #{endDate}
        </if>
        and ctmo.p_order_id = '0'
        GROUP BY
        ccu.username
        ORDER BY
        <if test="sortField == null or sortField==0" >
            count
        </if>
        <if test="sortField != null and sortField==1" >
            completeTotal
        </if>
        <if test="sortField != null and sortField==2" >
            completeCount
        </if>
        <if test="sortField != null and sortField==3" >
            cancelTotal
        </if>
        <if test="sortField != null and sortField==4" >
            cancelCount
        </if>
        <if test="sort != null and sortField==0" >
            asc
        </if>
        <if test="sort == null or sortField==1" >
            desc
        </if>
    </select>

    <select id="getTotalCash" resultType="java.math.BigDecimal">
        SELECT
        SUM(ctmo.merchant_proceeds)
        FROM
        ct_master_order ctmo
        where
        ctmo.merchant_id = #{merchantId}
        and ctmo.`status` = 10
        <if test="startTime1 != null and startTime1!=''" >
            and date_format(ctmo.create_date, '%Y-%m-%d') &gt;= #{startTime1}
        </if>
        <if test="endTime1 != null and endTime1!=''" >
            and date_format(ctmo.create_date, '%Y-%m-%d') &lt;= #{endTime1}
        </if>
    </select>

    <select id="getMerchantAccount" parameterType="io.treasure.dto.MerchantAccountDto" resultType="io.treasure.vo.MerchantAccountVo">
        select
        ctm.id,
        ctm.`name`,
        ctm.mobile,
        ctm.total_cash as totalCash,
        ctm.already_cash as alreadyCash,
        ctm.not_cash as notCash,
        ctm.wart_cash as wartCash,
        ctm.point_money as pointMoney,
        (
        SELECT
        COUNT(ctmo.id)
        from
        ct_master_order ctmo
        where
        ctm.id = ctmo.merchant_id
        and ctmo.`status` = 10
        and date_format(ctmo.eat_time, '%Y-%m') in
        <foreach collection="dateList" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        ) as count
        from
        ct_merchant ctm
        <where>
            <if test="name != null and name!=''" >
                and ctm.`name` like concat('%', #{name}, '%')
            </if>
            <if test="mobile != null and mobile!=''" >
                and ctm.mobile like concat('%', #{mobile}, '%')
            </if>
            <if test="id != null and id!=''" >
                and ctm.id = #{id}
            </if>
        </where>
        GROUP BY
        ctm.total_cash desc
    </select>

    <select id="getCompletaOrder" resultType="java.math.BigDecimal">
        SELECT count(0) FROM `ct_master_order`
        where merchant_id = #{merchantId}
        and `status` = 10
        and p_order_id = '0'
        <if test="startTime1 != null and startTime1!=''" >
            and date_format(create_date, '%Y-%m-%d') &gt;= #{startTime1}
        </if>
        <if test="endTime1 != null and endTime1!=''" >
            and date_format(create_date, '%Y-%m-%d') &lt;= #{endTime1}
        </if>
    </select>

    <select id="getReturnDishesPage" resultType="io.treasure.vo.ReturnDishesPageVo">
        select
            ctmo.order_id as orderId,
            ctmo.contacts,
            ctmo.contact_number as contactNumber,
            ( select ctmr.`name` from ct_merchant_room ctmr where ctmr.id = ctmo.room_id ) as roomName,
            ctmo.pay_money as payMoney,
            ctmo.description,
            ctmo.eat_time as eatTime
        from
            ct_master_order ctmo
        LEFT JOIN
            ct_slave_order ctso on ctso.order_id = ctmo.order_id and ctmo.merchant_id = #{merchantId}
        where
            ctmo.`status` = 2
            and ctso.`status` = 6
            and ctmo.merchant_id = #{merchantId}
            <if test="orderId != null" >
            and ctmo.order_id like concat('%', #{orderId}, '%')
            </if>
        ORDER BY ctmo.eat_time ASC
    </select>

    <select id="getVisualizationRoom" resultType="io.treasure.vo.VisualizationRoomVo">
        SELECT
            room.id,
            ct.type,
            ct.creator,
            room.`name` as roomName,
            room.icon,
            room.num_low as numLow,
            room.num_high as numHigh,
            (SELECT ctp.content FROM ct_merchant_room_params ctp WHERE ctp.id = 1) as oneTime,
            (SELECT ctp.content FROM ct_merchant_room_params ctp WHERE ctp.id = 2) as twoTime,
            (SELECT ctp.content FROM ct_merchant_room_params ctp WHERE ctp.id = 3) as threeTime,
            (SELECT ctp.content FROM ct_merchant_room_params ctp WHERE ctp.id = 4) as fourTime,
            (
                select ct2.state from ct_merchant_room_params_set ct2
                where
                date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 1
                and ct2.room_id = ct.room_id
            ) as oneState,
            (
                select ct2.state from ct_merchant_room_params_set ct2
                where
                date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 2
                and ct2.room_id = ct.room_id
            ) as twoState,
            (
                select ct2.state from ct_merchant_room_params_set ct2
                where date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 3
                and ct2.room_id = ct.room_id
            ) as threeState,
            (
                select ct2.state from ct_merchant_room_params_set ct2
                where date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 4
                and ct2.room_id = ct.room_id
            ) as fourState,
            (
                select ct2.creator from ct_merchant_room_params_set ct2
                where
                date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 1
                and ct2.room_id = ct.room_id
            ) as oneCreator,
            (
                select ct2.creator from ct_merchant_room_params_set ct2
                where
                date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 2
                and ct2.room_id = ct.room_id
            ) as twoCreator,
            (
                select ct2.creator from ct_merchant_room_params_set ct2
                where date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 3
                and ct2.room_id = ct.room_id
            ) as threeCreator,
            (
                select ct2.creator from ct_merchant_room_params_set ct2
                where date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 4
                and ct2.room_id = ct.room_id
            ) as fourCreator,
            (
                select ct2.id from ct_merchant_room_params_set ct2
                where
                date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 1
                and ct2.room_id = ct.room_id
            ) as oneCid,
            (
                select ct2.id from ct_merchant_room_params_set ct2
                where
                date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 2
                and ct2.room_id = ct.room_id
            ) as twoCid,
            (
                select ct2.id from ct_merchant_room_params_set ct2
                where date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 3
                and ct2.room_id = ct.room_id
            ) as threeCid,
            (
                select ct2.id from ct_merchant_room_params_set ct2
                where date_format(ct2.use_date, '%Y-%m-%d') = #{time}
                and ct2.room_params_id = 4
                and ct2.room_id = ct.room_id
            ) as fourCid
        from
            ct_merchant_room_params_set ct
        LEFT JOIN
            ct_merchant_room room on room.id = ct.room_id
        where
            ct.merchant_id = #{merchantId}
            and ct.`status` != 9
            and room.`status` != 9
            and date_format(ct.use_date, '%Y-%m-%d') = #{time}
        GROUP BY
            ct.room_id
        ORDER BY
	        ct.create_date
    </select>

    <select id="selectRoomAllByMid" resultType="io.treasure.vo.VisualizationRoomVo">
        select
        room.id,
        room.type,
        room.`name` as roomName,
        room.icon,
        room.num_low as numLow,
        room.num_high as numHigh,
        1 as flag
        from ct_merchant_room room
        where room.`status` != 9 and room.merchant_id = #{merchantId} and
        room.id not in (select DISTINCT ct.room_id from ct_merchant_room_params_set ct where ct.merchant_id = #{merchantId})
    </select>

</mapper>